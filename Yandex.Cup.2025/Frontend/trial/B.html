<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Builder API Sandbox</title>
    <style>
        body {
            font-size: 24px;
        }
    </style>
</head>
<body>
    <h4 style="margin: 10px 0">Expected</h4>
    <div id="example-root" style="display: inline-flex; border: solid 1px black; border-radius: 5px; padding: 10px;">
        <!-- Квадрат -->
        <div style="width: 100px; height: 100px; background-color: blue;  margin-right: 14px;"></div>
        <!-- Круг -->
        <div style="width: 100px; height: 100px; background-color: red; border-radius: 50%;"></div>
        <!-- Треугольник -->
        <div style="width: 0; height: 0; border-left: 50px solid transparent; border-right: 50px solid transparent; border-bottom: 100px solid green;"></div>
    </div>
    <h4 style="margin: 10px 0">Your result</h4>
    <div id="root">
    </div>

    <script>
        function solution() {
            function _camelToKebabCase(str) {
                return str.replace(/([a-z0-9]|(?=[A-Z]))([A-Z])/g, '$1-$2').toLowerCase();
            }

            function _api(type, args) {
                const context = {...this};
                context._history ??= [];
                context._context ??= ['*'];
                args.unshift(context._context.join(' '));
                context._history.push({type, args});
                return context;
            }

            function _contextPush(value) {
                const context = {...this};
                context._context ??= [];
                context._context.push(value);
                return context;
            }

            return {
                root(selector) {
                    if (this._context?.length) {
                        return this;
                    }
                    return _contextPush.call(this, selector);
                },

                select(selector = '*') {
                    return _contextPush.call(this, selector);
                },

                children(selector = '*') {
                    return _contextPush.call(this, `> ${selector}`);
                },

                append(tag, attrs = {}) {
                    return _api.call(this, 'append', [tag, attrs]);
                },

                appendMany(count, tag, attrs = {}) {
                    let context = { ...this };
                    for (let i = 0; i < count; i++) {
                        const resAttrs = typeof attrs === 'function' ? attrs(i) : attrs;
                        context = this.append.call(context, tag, resAttrs);
                    }
                    return context;
                },

                css(propertyOrDict, value) {
                    let properties = propertyOrDict;
                    if (typeof propertyOrDict === 'string') {
                        properties = { [propertyOrDict]: value };
                    }
                    return _api.call(this, 'css', [properties]);
                },

                remove(selector) {
                    return _api.call(this, 'remove', [selector]);
                },

                previousContext(steps = 1) {
                    const context = { ...this };
                    context._context ??= [];
                    context._context = context._context.slice(0, Math.max(1, context._context.length - steps));
                    return context;
                },

                commit() {
                    const domCache = {};
                    function _getElements(selector) {
                        const fromCache = domCache[selector];
                        if (fromCache) {
                            return fromCache;
                        }

                        const elements = document.querySelectorAll(selector);
                        domCache[selector] = elements;
                        return elements;
                    }

                    const perform = {
                        css(elements, properties) {
                            _getElements(elements).forEach((el) => {
                                Object.entries(properties).forEach(([key, value]) => {
                                    el.style.setProperty(_camelToKebabCase(key), value);
                                });
                            });
                        },

                        append(elements, tag, attrs) {
                            _getElements(elements).forEach((el) => {
                                const child = document.createElement(tag);
                                Object.entries(attrs).forEach(([key, value]) => {
                                    if (key === 'content') {
                                        child.textContent = value;
                                    } else {
                                        child.setAttribute(_camelToKebabCase(key), value);
                                    }
                                });
                                el.appendChild(child);
                            });
                        },

                        remove(elements, selector) {
                            _getElements(elements).forEach((el) => {
                                if (selector) {
                                    el.querySelectorAll(selector).forEach((el) => el.remove());
                                } else {
                                    el.remove();
                                }
                            });
                            if (!selector) {
                                delete domCache[elements];
                            }
                        },
                    };

                    (this._history ?? []).forEach(({ type, args }) => {
                        perform[type](...args);
                    });
                },
            };
        }

        const builder = solution();

        builder.root('#root')
            .css({border: 'solid 1px black', borderRadius: '5px', padding: '10px', display: 'inline-flex'})
            .append('div', {id: 'square'})
            .children('#square')
            .css({width: '100px', height: '100px', backgroundColor: 'blue', marginRight: '14px'})
            .previousContext()
            .append('div', {id: 'circle'})
            .children('#circle')
            .css({width: '100px', height: '100px', backgroundColor: 'red', borderRadius: '50%'})
            .previousContext()
            .append('div', {id: 'triangle'})
            .children('#triangle')
            .css({width: '0', height: '0', borderLeft: '50px solid transparent', borderRight: '50px solid transparent', borderBottom: '100px solid green'})
            .commit();
    </script>
</body>
</html>
